<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>中国新冠肺炎疫情地图可视化 | Hugo XMag</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">

  </head>

  <body class="page">
    <nav class="header">
      <div class="banner">
<a href="/" class="text">
&Hfr;&Ufr;&Gfr;&Ofr; &Xfr;&Mfr;&Afr;&Gfr;
</a>
</div>

      <div class="head-meta">
      
        <span><a href="/">&larr; Back to Home</a></span>
        <span class="date">2021-12-01</span>
        
        
        
          
        
        
        
        <span><a href="https://github.com/yihui/hugo-xmag/edit/master/exampleSite/content/post/2023-07-25-china-Covid19-map/index.Rmd">Edit this page &rarr;</a></span>
        
        
      
      </div>
    </nav>

<div class="container">
<article>
<div class="article-meta">

  <div class="categories">
  
    <a href="/categories/r">R</a>
  
  </div>

  <h1><span class="title">中国新冠肺炎疫情地图可视化</span></h1>

  
  <h3 class="author">学R不思则罔
</h3>
  

  
  <p>Tags: <a href="/tags/dplyr">dplyr</a>; <a href="/tags/sf">sf</a>; <a href="/tags/ggplot2">ggplot2</a>
  </p>
  
  

</div>


<nav id="TableOfContents"></nav>


<main>
<h1 id="1加载扩展包">1.加载扩展包</h1>
<pre><code class="language-r">library(readxl)
library(dplyr)
library(ggplot2)
library(sf)
</code></pre>
<h1 id="2数据处理">2.数据处理</h1>
<pre><code class="language-r">data &lt;- read_excel(&quot;data.xlsx&quot;) %&gt;% 
  mutate(date = as.Date(date)) %&gt;% 
  dplyr::filter(date == &quot;2020-02-25&quot;) %&gt;% 
  dplyr::filter(countrycode == &quot;CN&quot;) %&gt;% 
  dplyr::filter(! is.na(provincecode)) %&gt;% 
  mutate(across(.cols = provincecode,.fns = as.character)) %&gt;% 
  group_by(province,provincecode) %&gt;% 
  summarise(confirmed = sum(confirmed,na.rm = TRUE))
</code></pre>
<pre><code>## `summarise()` has grouped output by 'province'. You can override using the
## `.groups` argument.
</code></pre>
<pre><code class="language-r">kableExtra::kable(head(data))
</code></pre>
<table>
 <thead>
  <tr>
   <th style="text-align:left;"> province </th>
   <th style="text-align:left;"> provincecode </th>
   <th style="text-align:right;"> confirmed </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 上海市 </td>
   <td style="text-align:left;"> 310000 </td>
   <td style="text-align:right;"> 672 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 云南省 </td>
   <td style="text-align:left;"> 530000 </td>
   <td style="text-align:right;"> 348 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:left;"> 150000 </td>
   <td style="text-align:right;"> 150 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 北京市 </td>
   <td style="text-align:left;"> 110000 </td>
   <td style="text-align:right;"> 800 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 台湾省 </td>
   <td style="text-align:left;"> 710000 </td>
   <td style="text-align:right;"> 62 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 吉林省 </td>
   <td style="text-align:left;"> 220000 </td>
   <td style="text-align:right;"> 186 </td>
  </tr>
</tbody>
</table>
<pre><code class="language-r">province_sf &lt;- read_sf('china_prov_full_map.json') %&gt;% 
  mutate(across(.cols = 省代码,.fns = as.character)) %&gt;% 
  left_join(x = .,y = data,by = c(&quot;省代码&quot; = &quot;provincecode&quot;))
kableExtra::kable(head(province_sf))
</code></pre>
<table>
 <thead>
  <tr>
   <th style="text-align:left;"> 省代码 </th>
   <th style="text-align:left;"> 省 </th>
   <th style="text-align:left;"> 类型 </th>
   <th style="text-align:left;"> geometry </th>
   <th style="text-align:left;"> province </th>
   <th style="text-align:right;"> confirmed </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 110000 </td>
   <td style="text-align:left;"> 北京市 </td>
   <td style="text-align:left;"> 直辖市 </td>
   <td style="text-align:left;"> POLYGON ((944606.7 4978448,... </td>
   <td style="text-align:left;"> 北京市 </td>
   <td style="text-align:right;"> 800 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 120000 </td>
   <td style="text-align:left;"> 天津市 </td>
   <td style="text-align:left;"> 直辖市 </td>
   <td style="text-align:left;"> POLYGON ((1019641 4904366, ... </td>
   <td style="text-align:left;"> 天津市 </td>
   <td style="text-align:right;"> 270 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 130000 </td>
   <td style="text-align:left;"> 河北省 </td>
   <td style="text-align:left;"> 省 </td>
   <td style="text-align:left;"> MULTIPOLYGON (((1155620 480... </td>
   <td style="text-align:left;"> 河北省 </td>
   <td style="text-align:right;"> 622 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 140000 </td>
   <td style="text-align:left;"> 山西省 </td>
   <td style="text-align:left;"> 省 </td>
   <td style="text-align:left;"> POLYGON ((744116.6 4918659,... </td>
   <td style="text-align:left;"> 山西省 </td>
   <td style="text-align:right;"> 266 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 150000 </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:left;"> 自治区 </td>
   <td style="text-align:left;"> POLYGON ((1055732 6334586, ... </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:right;"> 150 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 150000 </td>
   <td style="text-align:left;"> 中朝共有 </td>
   <td style="text-align:left;"> 不统计 </td>
   <td style="text-align:left;"> MULTIPOLYGON (((1584839 498... </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:right;"> 150 </td>
  </tr>
</tbody>
</table>
<h1 id="3绘图">3.绘图</h1>
<blockquote>
<p><strong>[!Note]</strong>     <br>
对数据进行一次分组,具体分组在代码里面</p>
</blockquote>
<pre><code class="language-r">library(extrafont)
library(showtext)
showtext_auto(enable = TRUE)
font_add(&quot;Times&quot;, &quot;./font/Times New Roman.ttf&quot;)
font_add(&quot;KaiTi&quot;, &quot;./font/KaiTi.ttf&quot;)
</code></pre>
<pre><code class="language-r">province_sf &lt;- read_sf('china_prov_full_map.json') %&gt;%
  mutate(across(.cols = 省代码,.fns = as.character)) %&gt;% 
  left_join(x = .,y = data,by = c(&quot;省代码&quot; = &quot;provincecode&quot;)) %&gt;% 
  mutate(confirmed_dis = case_when(
    is.na(confirmed) ~ &quot;0~100&quot;,
    confirmed &lt;= 100 ~ &quot;0~100&quot;,
    confirmed &lt;= 500 ~ &quot;100~500&quot;,
    confirmed &lt;= 1000 ~ &quot;500~1000&quot;,
    confirmed &lt;= 1500 ~ &quot;1000~1500&quot;,
    confirmed &lt;= 2000 ~ &quot;1500~2000&quot;,
    confirmed &lt;= 3000 ~ &quot;2000~3000&quot;,
    TRUE ~ &quot;&gt;3000&quot;
  ))
kableExtra::kable(head(province_sf))
</code></pre>
<table>
 <thead>
  <tr>
   <th style="text-align:left;"> 省代码 </th>
   <th style="text-align:left;"> 省 </th>
   <th style="text-align:left;"> 类型 </th>
   <th style="text-align:left;"> geometry </th>
   <th style="text-align:left;"> province </th>
   <th style="text-align:right;"> confirmed </th>
   <th style="text-align:left;"> confirmed_dis </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 110000 </td>
   <td style="text-align:left;"> 北京市 </td>
   <td style="text-align:left;"> 直辖市 </td>
   <td style="text-align:left;"> POLYGON ((944606.7 4978448,... </td>
   <td style="text-align:left;"> 北京市 </td>
   <td style="text-align:right;"> 800 </td>
   <td style="text-align:left;"> 500~1000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 120000 </td>
   <td style="text-align:left;"> 天津市 </td>
   <td style="text-align:left;"> 直辖市 </td>
   <td style="text-align:left;"> POLYGON ((1019641 4904366, ... </td>
   <td style="text-align:left;"> 天津市 </td>
   <td style="text-align:right;"> 270 </td>
   <td style="text-align:left;"> 100~500 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 130000 </td>
   <td style="text-align:left;"> 河北省 </td>
   <td style="text-align:left;"> 省 </td>
   <td style="text-align:left;"> MULTIPOLYGON (((1155620 480... </td>
   <td style="text-align:left;"> 河北省 </td>
   <td style="text-align:right;"> 622 </td>
   <td style="text-align:left;"> 500~1000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 140000 </td>
   <td style="text-align:left;"> 山西省 </td>
   <td style="text-align:left;"> 省 </td>
   <td style="text-align:left;"> POLYGON ((744116.6 4918659,... </td>
   <td style="text-align:left;"> 山西省 </td>
   <td style="text-align:right;"> 266 </td>
   <td style="text-align:left;"> 100~500 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 150000 </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:left;"> 自治区 </td>
   <td style="text-align:left;"> POLYGON ((1055732 6334586, ... </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:right;"> 150 </td>
   <td style="text-align:left;"> 100~500 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 150000 </td>
   <td style="text-align:left;"> 中朝共有 </td>
   <td style="text-align:left;"> 不统计 </td>
   <td style="text-align:left;"> MULTIPOLYGON (((1584839 498... </td>
   <td style="text-align:left;"> 内蒙古自治区 </td>
   <td style="text-align:right;"> 150 </td>
   <td style="text-align:left;"> 100~500 </td>
  </tr>
</tbody>
</table>
<pre><code class="language-r">library(stringr)
library(ggsflabel)
</code></pre>
<pre><code>## 
## Attaching package: 'ggsflabel'
</code></pre>
<pre><code>## The following objects are masked from 'package:ggplot2':
## 
##     geom_sf_label, geom_sf_text, StatSfCoordinates
</code></pre>
<pre><code class="language-r">library(ggspatial)
</code></pre>
<pre><code>## Warning: package 'ggspatial' was built under R version 4.2.3
</code></pre>
<pre><code class="language-r">ggplot(province_sf) + 
  geom_sf(aes(fill = confirmed_dis),size = 0.1,color = &quot;black&quot;) +
  scale_fill_manual(
    values = c(&quot;0~100&quot; = &quot;#FEF1DD&quot;,
               &quot;100~500&quot; = &quot;#FDDDB2&quot;,
               &quot;500~1000&quot; = &quot;#FDC38D&quot;, 
               &quot;1000~1500&quot; = &quot;#FC9863&quot;,
               &quot;1500~2000&quot; = &quot;#EF6648&quot;,
               &quot;2000~3000&quot; = &quot;#D42C1C&quot;,
               &quot;&gt;3000&quot; = &quot;#A80000&quot;)
  ) +
  geom_sf_label_repel(
    data = province_sf %&gt;% 
      dplyr::filter(str_sub(省,nchar(省)) %in% c(&quot;省&quot;,&quot;区&quot;,&quot;市&quot;)),
    aes(label = 省),family = 'KaiTi',
    nudge_x = -5, nudge_y = -5, seed = 10
  ) +
  guides(fill = guide_legend(nrow = 2,byrow = TRUE)) + 
  theme(plot.title = element_text(size = 16,hjust = 0.5,vjust = 0.5,face = &quot;bold&quot;,family = &quot;KaiTi&quot;),
        plot.subtitle = element_text(size = 12,hjust = 0.5,vjust = 0.5,face = &quot;bold&quot;,family = &quot;KaiTi&quot;),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;,
        legend.text = element_text(family = &quot;Times&quot;),
        legend.title = element_text(family = &quot;KaiTi&quot;)) + 
  labs(fill = &quot;确诊人数&quot;, 
       title = &quot;新冠肺炎确诊病例省份分布&quot;,
       subtitle = paste0(&quot;2020-02-25 确诊病例 &quot;,sum(province_sf$confirmed,na.rm = TRUE))) + 
  annotation_scale(location = &quot;bl&quot;, width_hint = 0.3) +
  annotation_north_arrow(location = &quot;tr&quot;, which_north = &quot;false&quot;,
                         pad_x = unit(0.9, &quot;cm&quot;),
                         pad_y = unit(0.4, &quot;cm&quot;),
                         style = north_arrow_fancy_orienteering(
                           text_family = &quot;KaiTi&quot;
                         )) + 
  coord_sf(ylim = c(2068000, 6387786))
</code></pre>
<pre><code>## Scale on map varies by more than 10%, scale bar may be inaccurate
</code></pre>
<img src="/post/2021/12/01/%E4%B8%AD%E5%9B%BD%E6%96%B0%E5%86%A0%E8%82%BA%E7%82%8E%E7%96%AB%E6%83%85%E5%9C%B0%E5%9B%BE%E5%8F%AF%E8%A7%86%E5%8C%96/index_files/figure-html/unnamed-chunk-6-1.png" width="960" />
<pre><code class="language-r">ggsave(&quot;新冠肺炎确诊病例省份分布.png&quot;,dpi = 200)
</code></pre>
<pre><code>## Saving 7 x 5 in image
## Scale on map varies by more than 10%, scale bar may be inaccurate
</code></pre>
<hr>

</main>


















<nav class="post-nav">
  <span class="nav-prev"><a href="/post/2022/12/01/tmap%E7%BB%98%E5%88%B6%E6%84%8F%E5%A4%A7%E5%88%A9%E5%9C%B0%E5%BD%A2%E5%9B%BE/">&larr; tmap绘制意大利地形图</a></span>
  <span class="nav-next"><a href="/post/2020/12/01/hello-r-markdown/">Hello R Markdown &rarr;</a></span>
</nav>



</article>
</div>

<script async src="//yihui.org/js/center-img.js"></script>

<footer>

<div class="footer">
  <ul class="menu">
    
    <li><a href="/"><span data-hover="Home">Home</span></a></li>
    
    <li><a href="/about/"><span data-hover="About">About</span></a></li>
    
    <li><a href="/categories/"><span data-hover="Categories">Categories</span></a></li>
    
    <li><a href="/tags/"><span data-hover="Tags">Tags</span></a></li>
    
    <li><a href="/index.xml"><span data-hover="Subscribe">Subscribe</span></a></li>
    
  </ul>
  
  <div class="copyright">© <a href="https://yihui.org">Yihui Xie</a> 2017 - 2020 | <a href="https://github.com/yihui">Github</a> | <a href="https://twitter.com/xieyihui">Twitter</a></div>
  
</div>
</footer>


<script src="//yihui.org/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script>
hljs.configure({languages: []});
hljs.initHighlightingOnLoad();
</script>




</body>
</html>

