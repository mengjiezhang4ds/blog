<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>栅格数据偏相关分析 | Hugo XMag</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">

  </head>

  <body class="page">
    <nav class="header">
      <div class="banner">
<a href="/" class="text">
&Hfr;&Ufr;&Gfr;&Ofr; &Xfr;&Mfr;&Afr;&Gfr;
</a>
</div>

      <div class="head-meta">
      
        <span><a href="/">&larr; Back to Home</a></span>
        <span class="date">2023-01-05</span>
        
        
        
          
        
        
        
        <span><a href="https://github.com/yihui/hugo-xmag/edit/master/exampleSite/content/post/2023-01-01-partial-correlation/index.Rmd">Edit this page &rarr;</a></span>
        
        
      
      </div>
    </nav>

<div class="container">
<article>
<div class="article-meta">

  <div class="categories">
  
    <a href="/categories/r">R</a>
  
  </div>

  <h1><span class="title">栅格数据偏相关分析</span></h1>

  
  <h3 class="author">学R不思则罔
</h3>
  

  
  <p>Tags: <a href="/tags/dplyr">dplyr</a>; <a href="/tags/terra">terra</a>; <a href="/tags/ggplot2">ggplot2</a>
  </p>
  
  

</div>


<nav id="TableOfContents">
  <ul>
    <li><a href="#0西海情歌">0.西海情歌</a></li>
    <li><a href="#1无缺失值情况">1.无缺失值情况</a>
      <ul>
        <li><a href="#11-生成数据">1.1 生成数据</a></li>
        <li><a href="#12-编写函数">1.2 编写函数</a></li>
        <li><a href="#13-结果可视化">1.3 结果可视化</a></li>
      </ul>
    </li>
    <li><a href="#2存在缺失值情况">2.存在缺失值情况</a>
      <ul>
        <li><a href="#21-生成数据">2.1 生成数据</a></li>
        <li><a href="#22-编写函数">2.2 编写函数</a></li>
        <li><a href="#23-结果可视化">2.3 结果可视化</a></li>
        <li><a href="#24-结果保存删除">2.4 结果保存删除</a></li>
      </ul>
    </li>
  </ul>
</nav>


<main>
<h2 id="0西海情歌">0.西海情歌</h2>
<pre><code class="language-r">library(embedr)
audio &lt;- &quot;西海情歌.mp3&quot;
embed_audio(audio, attribute = c(&quot;controls&quot;))
</code></pre>
<p><audio controls> <source src='西海情歌.mp3' type='audio/mpeg'> Your browser does not support the audio tag;  for browser support, please see:  <a href="https://www.w3schools.com/tags/tag_audio.asp">https://www.w3schools.com/tags/tag_audio.asp</a> </audio></p>
<pre><code class="language-r">library(terra)
library(tidyverse)
library(tidyterra)
</code></pre>
<h2 id="1无缺失值情况">1.无缺失值情况</h2>
<h3 id="11-生成数据">1.1 生成数据</h3>
<pre><code class="language-r">sos &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
tem &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
pre &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
NDVI &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
z &lt;- c(NDVI, tem, pre)
</code></pre>
<h3 id="12-编写函数">1.2 编写函数</h3>
<pre><code class="language-r">fun_cor &lt;- function(x) {
  Rs &lt;- ppcor::pcor.test(x[1:20], x[21:40], x[41:60])
  Rx &lt;- Rs$estimate
  Px &lt;- Rs$p.value
  return(c(Rx, Px))
}
pc_res &lt;- app(z, fun_cor, cores = 4)
pc_res
</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 10, 10, 2  (nrow, ncol, nlyr)
## resolution  : 1, 1  (x, y)
## extent      : 0, 10, 0, 10  (xmin, xmax, ymin, ymax)
## coord. ref. :  
## source(s)   : memory
## names       :      lyr.1,       lyr.2 
## min values  : -0.6715273, 0.001641855 
## max values  :  0.5543745, 0.993421419
</code></pre>
<h3 id="13-结果可视化">1.3 结果可视化</h3>
<pre><code class="language-r">plot(pc_res)
</code></pre>
<img src="/post/2023/01/05/%E6%A0%85%E6%A0%BC%E6%95%B0%E6%8D%AE%E5%81%8F%E7%9B%B8%E5%85%B3%E5%88%86%E6%9E%90/index_files/figure-html/unnamed-chunk-5-1.png" width="672" />
<h2 id="2存在缺失值情况">2.存在缺失值情况</h2>
<h3 id="21-生成数据">2.1 生成数据</h3>
<pre><code class="language-r">ndvi &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
names(ndvi) &lt;- paste0(&quot;ndvi&quot;, 1:20)
sos &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
names(sos) &lt;- paste0(&quot;sos&quot;, 1:20)
tem &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
names(tem) &lt;- paste0(&quot;tem&quot;, 1:20)
ssd &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
names(ssd) &lt;- paste0(&quot;ssd&quot;, 1:20)
pre &lt;- rast(array(runif(10 * 10 * 20), c(10, 10, 20)))
names(pre) &lt;- paste0(&quot;pre&quot;, 1:20)
# 合并数据
all_data &lt;- c(ndvi, sos, tem, ssd, pre)
all_data
</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 10, 10, 100  (nrow, ncol, nlyr)
## resolution  : 1, 1  (x, y)
## extent      : 0, 10, 0, 10  (xmin, xmax, ymin, ymax)
## coord. ref. :  
## source(s)   : memory
## names       :       ndvi1,       ndvi2,       ndvi3,        ndvi4,      ndvi5,      ndvi6, ... 
## min values  : 0.005713493, 0.007358169, 0.001519259, 0.0003856248, 0.01222557, 0.01009995, ... 
## max values  : 0.999250853, 0.995558584, 0.996669351, 0.9967179818, 0.98248789, 0.99712850, ...
</code></pre>
<h3 id="22-编写函数">2.2 编写函数</h3>
<pre><code class="language-r">func_pcor &lt;- function(x) {
  temp_ndvi &lt;- x[1:20]
  temp_sos &lt;- x[21:40]
  temp_tem &lt;- x[41:60]
  temp_ssd &lt;- x[61:80]
  temp_pre &lt;- x[81:100]

  temp_data &lt;- data.frame(cbind(temp_ndvi, temp_sos, temp_tem, temp_ssd, temp_pre))

  if (is.na(sum(temp_data))) {
    return(c(NA, NA, NA, NA, NA, NA, NA, NA))
  } else {
    corValue &lt;- ppcor::pcor(temp_data)
    # 相关系数
    cor_pre &lt;- corValue$estimate[1, 2]
    cor_tem &lt;- corValue$estimate[1, 3]
    cor_rhu &lt;- corValue$estimate[1, 4]
    cor_ssd &lt;- corValue$estimate[1, 5]
    # 显著性
    pvalue_pre &lt;- corValue$p.value[1, 2]
    pvalue_tem &lt;- corValue$p.value[1, 3]
    pvalue_rhu &lt;- corValue$p.value[1, 4]
    pvalue_ssd &lt;- corValue$p.value[1, 5]

    print(c(cor_pre, cor_tem, cor_rhu, cor_ssd))
    return(c(cor_pre, pvalue_pre, cor_tem, pvalue_tem, cor_rhu, pvalue_rhu, cor_ssd, pvalue_ssd))
  }
}
pc_res &lt;- terra::app(all_data, func_pcor, cores = 8)
</code></pre>
<pre><code>## [1]  0.1109228  0.1524621  0.1571929 -0.1581176
## [1] -0.2370984 -0.3740203 -0.3060371 -0.2669154
## [1]  0.29817136 -0.08232196 -0.23883653 -0.07014584
## [1] -0.1489053 -0.3588139 -0.2812474  0.4646105
## [1] -0.3654143  0.1390341 -0.2352565 -0.3259933
## [1]  0.01927616  0.20679737 -0.13743319 -0.42337333
## [1]  0.21838445  0.05984813 -0.17028954 -0.37680067
## [1] -0.30852194 -0.17220729 -0.48607360 -0.03088648
## [1] -0.09231782 -0.10577304  0.31940466 -0.05586390
## [1]  0.04020495  0.27958506  0.03005220 -0.17942730
</code></pre>
<pre><code class="language-r"># names(pc_res) = c(&quot;pre&quot;,&quot;pre_pvalue&quot;, &quot;tem&quot;,&quot;tem_pvalue&quot;,&quot;rhu&quot;,&quot;rhu_pvalue&quot;,&quot;ssd&quot;,&quot;ssd_pvalue&quot;)
</code></pre>
<h3 id="23-结果可视化">2.3 结果可视化</h3>
<pre><code class="language-r">plot(pc_res)
</code></pre>
<img src="/post/2023/01/05/%E6%A0%85%E6%A0%BC%E6%95%B0%E6%8D%AE%E5%81%8F%E7%9B%B8%E5%85%B3%E5%88%86%E6%9E%90/index_files/figure-html/unnamed-chunk-8-1.png" width="672" />
<h3 id="24-结果保存删除">2.4 结果保存删除</h3>
<pre><code class="language-r">writeRaster(pc_res, &quot;pc_res.tif&quot;, overwrite = TRUE)
rast(&quot;pc_res.tif&quot;) %&gt;% plot()
</code></pre>
<img src="/post/2023/01/05/%E6%A0%85%E6%A0%BC%E6%95%B0%E6%8D%AE%E5%81%8F%E7%9B%B8%E5%85%B3%E5%88%86%E6%9E%90/index_files/figure-html/unnamed-chunk-9-1.png" width="672" />
<pre><code class="language-r">file.remove(&quot;pc_res.tif&quot;)
</code></pre>
<pre><code>## [1] TRUE
</code></pre>
<hr>

</main>


















<nav class="post-nav">
  <span class="nav-prev"><a href="/post/2023/04/01/%E5%9F%BA%E4%BA%8Er%E8%AF%AD%E8%A8%80caret%E5%8C%85%E7%9A%84%E4%B8%8A%E6%B5%B7%E5%B8%82%E9%92%89%E8%9E%BA%E5%88%86%E5%B8%83%E9%A2%84%E6%B5%8B/">&larr; 基于R语言caret包的上海市钉螺分布预测</a></span>
  <span class="nav-next"><a href="/post/2022/12/01/tmap%E7%BB%98%E5%88%B6%E6%84%8F%E5%A4%A7%E5%88%A9%E5%9C%B0%E5%BD%A2%E5%9B%BE/">tmap绘制意大利地形图 &rarr;</a></span>
</nav>



</article>
</div>

<script async src="//yihui.org/js/center-img.js"></script>

<footer>

<div class="footer">
  <ul class="menu">
    
    <li><a href="/"><span data-hover="Home">Home</span></a></li>
    
    <li><a href="/about/"><span data-hover="About">About</span></a></li>
    
    <li><a href="/categories/"><span data-hover="Categories">Categories</span></a></li>
    
    <li><a href="/tags/"><span data-hover="Tags">Tags</span></a></li>
    
    <li><a href="/index.xml"><span data-hover="Subscribe">Subscribe</span></a></li>
    
  </ul>
  
  <div class="copyright">© <a href="https://yihui.org">Yihui Xie</a> 2017 - 2020 | <a href="https://github.com/yihui">Github</a> | <a href="https://twitter.com/xieyihui">Twitter</a></div>
  
</div>
</footer>


<script src="//yihui.org/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script>
hljs.configure({languages: []});
hljs.initHighlightingOnLoad();
</script>




</body>
</html>

