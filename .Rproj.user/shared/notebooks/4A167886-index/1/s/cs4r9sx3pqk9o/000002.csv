"0","MKraster <- function(rasterstack, type=c(""trend"",""pval"",""both"")){"
"0","  "
"0","  # Values for (layers, ncell, ncol, nrow, method, crs, extent) come straight from the input raster stack"
"0","  # e.g. nlayers(rasterstack), ncell(rasterstack)... etc."
"0","  print(paste(""Start MKraster:"",Sys.time()))"
"0","  print(""Loading parameters"")"
"0","  layers=nlayers(rasterstack);ncell=ncell(rasterstack);"
"0","  ncol=ncol(rasterstack);nrow=nrow(rasterstack);crs=crs(rasterstack);"
"0","  extent=extent(rasterstack);pb = txtProgressBar(min = 0, max = ncell, initial = 0)"
"0","  print(""Done loading parameters"")"
"0","  mtrx <- as.matrix(rasterstack,ncol=layers)"
"0","  empt <- matrix(nrow=ncell, ncol=2)"
"0","  "
"0","  print(""Initiating loop operation"")"
"0","  if (type == ""trend""){"
"0","    "
"0","    for (i in 1:length(mtrx[,1])){"
"0","      if (all(is.na(mtrx[i,]))){ "
"0","        empt[i,1] <- NA "
"0","      } else "
"0","        if (sum(!is.na(mtrx[i,])) < 4){"
"0","          empt[i,1] <- NA "
"0","        } else "
"0","          empt[i,1] <- as.numeric(MannKendall(as.numeric(mtrx[i,]))$tau)"
"0","    }"
"0","    "
"0","    print(""Creating empty raster"")"
"0","    trend <- raster(nrows=nrow,ncols=ncol,crs=crs)"
"0","    extent(trend) <- extent"
"0","    print(""Populating trend raster"")"
"0","    values(trend) <- empt[,1]"
"0","    print(paste(""Ending MKraster on"",Sys.time()))"
"0","    trend"
"0","  } "
"0","  else"
"0","    if (type == ""pval""){"
"0","      "
"0","      for (i in 1:length(mtrx[,1])){"
"0","        if (all(is.na(mtrx[i,]))){ "
"0","          empt[i,1] <- NA "
"0","        } else "
"0","          if (sum(!is.na(mtrx[i,])) < 4){"
"0","            empt[i,1] <- NA "
"0","          } else "
"0","            empt[i,1] <- as.numeric(MannKendall(as.numeric(mtrx[i,]))$sl)"
"0","      }"
"0","      "
"0","      pval <- raster(nrows=nrow,ncols=ncol,crs=crs)"
"0","      extent(pval) <- extent"
"0","      print(""Populating significance raster"")"
"0","      values(pval) <- empt[,1]"
"0","      print(paste(""Ending MKraster on"",Sys.time()))"
"0","      pval"
"0","    }"
"0","  else"
"0","    if (type == ""both""){"
"0","      "
"0","      for (i in 1:length(mtrx[,1])){"
"0","        if (all(is.na(mtrx[i,]))){ "
"0","          empt[i,1] <- NA "
"0","        } else "
"0","          if (sum(!is.na(mtrx[i,])) < 4){"
"0","            empt[i,1] <- NA "
"0","          } else "
"0","            tryCatch({"
"0","              empt[i,1] <- as.numeric(MannKendall(as.numeric(mtrx[i,]))$tau)"
"0","              empt[i,2] <- as.numeric(MannKendall(as.numeric(mtrx[i,]))$sl)"
"0","            })"
"0","      }"
"0","      "
"0","      tr <- raster(nrows=nrow,ncols=ncol,crs=crs)"
"0","      pv <- raster(nrows=nrow,ncols=ncol,crs=crs)"
"0","      print(""Populating raster brick"")"
"0","      values(tr) <- empt[,1]"
"0","      values(pv) <- empt[,2]"
"0","      brk <- brick(tr,pv)"
"0","      extent(brk) <- extent"
"0","      names(brk) <- c(""trend"",""p.value"")"
"0","      print(paste(""Ending MKraster on"",Sys.time()))"
"0","      brk"
"0","    }"
"0","}"
